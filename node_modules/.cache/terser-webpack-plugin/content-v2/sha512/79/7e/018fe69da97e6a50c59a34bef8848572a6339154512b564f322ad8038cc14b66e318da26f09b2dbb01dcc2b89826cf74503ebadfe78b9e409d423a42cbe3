{"code":"!function(t){var e={};function i(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(t,\"__esModule\",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&\"object\"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,\"default\",{enumerable:!0,value:t}),2&e&&\"string\"!=typeof t)for(var r in t)i.d(s,r,function(e){return t[e]}.bind(null,r));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,\"a\",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p=\"\",i(i.s=0)}([function(t,e,i){\"use strict\";function s(t={}){var e={feId:\"line\"+(new Date).getTime(),originX:0,originY:0,isEnd:!1,lineRange:8,themeColor:\"#12d2cb\"};Object.assign(this,e,t)}i.r(e),s.prototype.setPoint=function(t={}){this.sx=t.sx||this.sx,this.sy=t.sy||this.sy,t.start&&(this.start=t.start),t.end&&(this.end=t.end),this.start&&this.end&&(this.isEnd=!0,this.styleEndPonit())},s.prototype.styleEndPonit=function(){this.isEnd?$(\"#\"+this.end.feId+\">.title-wraper>.dragableRect.end,#\"+this.start.feId+\">.title-wraper>.dragableRect.start\").addClass(\"connected\"):$(\"#\"+this.end.feId+\">.title-wraper>.dragableRect.end\").removeClass(\"connected\")},s.prototype.update=function(t={}){\"start\"===t.dir?(this.sx=t.x||this.sx,this.sy=t.y||this.sy):\"end\"===t.dir&&(this.ex=t.x||this.ex,this.ey=t.y||this.ey),this.start&&this.end&&(this.isEnd=!0,this.styleEndPonit())},s.prototype.reconnected=function(t,e){this.isEnd=!1,this.focus=!1;var i=this;e.find(function(t){return t.feId!=i.feId&&t.end.feId===i.end.feId})||this.styleEndPonit(),$(\"#\"+this.start.feId+\" .start\").removeClass(\"connected\"),this[t]=null},s.prototype.lineCoordinate=function(t={},e){var i=t.scrollLeft||0,s=t.scrollTop||0;if(this.start){var r=$(`#${this.start.feId} .start`)[0],n=$(r).offset()||{};this.sx=n.left-this.originX+i+e/2,this.sy=n.top-this.originY+s+e/2}if(this.end){var o=$(`#${this.end.feId} .end`)[0];n=$(o).offset();this.ex=n.left-this.originX+i+e/2,this.ey=n.top-this.originY+s+e/2}},s.prototype.isOnline=function(t,e){var i=Math.min(this.ey,this.sy),s=Math.max(this.ey,this.sy);if(Math.abs(this.ex-this.sx)<=this.lineRange&&t+this.lineRange>this.ex&&t-this.lineRange<this.ex&&e>=i&&e<=s)return!0;var r=(this.ey-this.sy)/(this.ex-this.sx),n=this.ey-r*this.ex,o=Math.min(this.ex,this.sx),a=Math.max(this.ex,this.sx);return r*t+n+this.lineRange>e&&r*t+n-this.lineRange<e&&t>=o&&t<=a},s.prototype.destroy=function(){this.isEnd=!0,this.isDestroy=!0},s.prototype._lineHover=function(t){console.log(\"line hover\")},s.prototype._lineClick=function(t){console.log(\"line click\")};var r=s;function n(){var t=$(\"<canvas></canvas>\")[0].getContext(\"2d\");return(window.devicePixelRatio||1)/(t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1)}function o(t,e,i){var s=(i.x-e.x)*(t.x-e.x)+(i.y-e.y)*(t.y-e.y);if(s<=0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));var r=Math.pow(i.x-e.x,2)+Math.pow(i.y-e.y,2);if(s>=r)return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2));var n=s/r,o=e.x+(i.x-e.x)*n,a=e.y+(i.y-e.y)*n;return Math.sqrt(Math.pow(t.x-o,2)+Math.pow(a-t.y,2))}function a(t={}){var e=n();this.isLast=!1,this.isFirst=!1,this.hasDelete=!1,this.hasSetting=!0,this.ratio=e,this.text=\"标题\",this.deleteWidth=10,this.canvasX=0,this.canvasY=0,this.x=0,this.y=0,this.containerHeight=0,this.feType=\"normal\",this.fontSize=14,this.textX=5,this.color=\"#333\",this.titleIcon=\"icon-shuxingtushouqi\",this.position=\"absolute\",this.toCenter=!1,Object.assign(this,t),this.className=t.className?t.className:\" flowBaseModule\",this.fontSize=this.fontSize*e,this.text=t.text?t.text:this.isFirst?\"开始\":this.isLast?\"结束\":\"标题\",this.textX=this.textX*e,this.$icon=void 0,this.$title=void 0,this.isLast?(this.canbeStart=!1,this.className+=\" last-module\"):void 0!==t.canbeStart?this.canbeStart=t.canbeStart:this.canbeStart=!0,this.isFirst?(this.canbeEnd=!1,this.className+=\" first-module\"):void 0!==t.canbeEnd?this.canbeEnd=t.canbeEnd:this.canbeEnd=!0,this.canDrag=void 0===t.canDrag||t.canDrag,this.font=`${this.fontSize}px Microsoft Yahei`,this.textY=this.height*this.ratio-(this.height*this.ratio-this.fontSize)/2}function h(t={}){this.canbeEnd=!0,this.canbeStart=!1,this.hasSetting=!0,this.childrenGap=10,this.feType=\"branchmodule\",this.children=[],this.className=\"hasChildren\",Object.assign(this,t),this.$icon=void 0,this.$title=void 0}function l(t={}){this.className=\"childModule\",this.canbeEnd=!1,this.canbeStart=!0,this.hasDelete=!1,this.hasSetting=!1,this.canDrag=!1,this.gap=10,this.width=80,this.height=20,this.feType=\"branch\",this.position=\"relative\",this.titleIcon=\"\";var e=Object.assign(this,t);e.width=e.parentwidth-2*e.gap,e.height=e.parentHeight-e.gap,Object.assign(this,e),this.$icon=void 0,this.$title=void 0}function c(t={}){this.feType=\"specialBranch\",Object.assign(this,t)}function d(t={}){this.lines=[],this.modules=[],this.ratio=n(),this.width=t.canvasWidth||1400,this.height=t.canvasHeight||1e3,this.themeColor=\"#12d2cb\",this.creatingModule=null,this.rectWidth=12,this.showNodesWraper=!0,this.deleteIcon=\"icon-IVR-shanchu\",this.lineRandomIds=[],this.moduleRandomIds=[],this.clickLineOnModule=!1,this.$wraper=t.wraper?$(t.wraper):$(\"body\");for(var e=0;e<=1e3;e++){if((e=String(e)).length<4)for(var i=4-e.length,s=1;s<=i;s++)e=\"0\"+e;this.lineRandomIds.push(e)}this.moduleRandomIds=this.lineRandomIds.concat([]),this.init(),this.initEvent()}a.prototype.update=function(t){Object.assign(this,t),this.drawModule()},a.prototype.drawModule=function(){var t,e,i;!this.$icon&&this.titleIcon?(t=$('<i class=\"'+this.titleIcon+' ivricon \"></i>'),this.$icon=t,this.titleWraper.append(t)):this.$icon&&this.$icon.removeClass().addClass(this.titleIcon+\" ivricon\"),this.$title?this.$title.html(this.text):(i=this.titleIcon?\"title-text hasLeftSepa\":\"title-text hasLeftMargin\",e=$('<span class=\"'+i+'\" title=\"'+this.text+'\">'+this.text+\"</span>\"),this.$title=e,this.titleWraper.append(e))},a.prototype.init=function(){this.$parent=this.$parent||this.flowchart&&this.flowchart.$parent;var t=this;if(this.rectWidth=this.flowchart.rectWidth,!this.feId){var e=this.flowchart.moduleRandomIds.shift(0);e||console.log(\"模块数量超出最大值1000\"),this.feId=\"module\"+(new Date).getTime()+e}var i=$('<div id=\"'+this.feId+'\" class=\"basemodule '+this.className+'\" style=\"position:'+this.position+'\"></div>');if(this.div=i,this.titleWraper=$('<div class=\"title-wraper\"></div>'),this.canDrag&&(i.mousedown(this.moveStart.bind(this)),$(\"body\").mousemove(this.moveDrag.bind(this)),$(\"body\").mouseup(this.moveEnd.bind(this)),$(\"html\").mouseleave(this.moveEnd.bind(this))),this.hasDelete){var s=this.deleteWidth,r=(this.height,$('<div class=\"module-delete\" id=\"delete'+this.feId+'\"><i class=\"'+this.flowchart.deleteIcon+'\"></i></div>'));this.delete=r,r.on(\"mousedown\",function(e){e.stopPropagation(),t.destroy(),t.flowchart.showNodes()}),this.titleWraper.append(r)}if(this.drawModule(),i.append(this.titleWraper),this.$parent.append(i),this.toCenter){var n=this.width||this.div.width(),o=this.titleHeight||this.titleWraper.height();this.x-=n/2,this.y-=o/2}\"absolute\"===this.position&&i.css({left:this.x+\"px\",top:this.y+\"px\"}),this.createdragableRect()},a.prototype.createdragableRect=function(){var t=this;if(this.canbeEnd){var e=$('<div class=\"dragableRect leftRect end\" draggable=\"true\"></div>');this.titleWraper.append(e)}if(this.canbeStart){var i=$('<div class=\"dragableRect rightRect start\" draggable=\"true\"></div>');this.titleWraper.append(i)}$(\"#\"+this.feId+\">.title-wraper>.dragableRect\").on(\"mousedown\",function(t){t.stopPropagation()}),$(\"body\").on(\"dragstart\",\"#\"+this.feId+\">.title-wraper>.dragableRect\",function(e){e=e.originalEvent;var i=$(e.target).parent().parent().attr(\"id\"),s=$(e.target).hasClass(\"start\")?\"start\":\"end\",n=\"start\"===s?\"end\":\"start\",o=t.flowchart.lines.find(function(t){return t.focus&&t[s].feId===i});if(o&&(o.reconnected(n,t.flowchart.lines),t.flowchart.$deLineIcon.hide()),\"start\"!=s||!$(e.target).hasClass(\"connected\")){if(e.dataTransfer.setDragImage(e.target,0,0),!o){var a;(a=new r({originX:t.flowchart.originX,originY:t.flowchart.originY}))[s]={feId:i},a.lineCoordinate(t.flowchart.scrollDistance(),t.rectWidth),t.flowchart.lines.push(a)}var h=s+\" \"+i;t.flowchart.currentDragStartModuleId=h,e.dataTransfer.effectAllowed=\"copy\",e.dataTransfer.setData(\"dragStartModuleId\",h)}}),this.flowchart.canvas.parent().unbind(\"dragover.BaseModuleNode\"),this.flowchart.canvas.parent().bind(\"dragover.BaseModuleNode\",function(e){(e=e.originalEvent).preventDefault();var i=t.flowchart.currentDragStartModuleId;if(i){var s=i.split(\" \"),r=s[0],n=\"start\"==r?\"end\":\"start\",o=s[1];if(t.flowchart.inScrollParent({x:e.pageX,y:e.pageY},40)?t.stopScroll():t.moveScroll(e),t.flowchart.inScrollParent({x:e.pageX,y:e.pageY})){var a=t.flowchart.scrollDistance(),h=e.pageX-t.flowchart.originX+a.scrollLeft,l=e.pageY-t.flowchart.originY+a.scrollTop;!$(e.target).hasClass(n)||\"start\"===n&&$(e.target).hasClass(\"connected\")?e.dataTransfer.dropEffect=\"none\":e.dataTransfer.dropEffect=\"copy\",t.flowchart.lines.forEach(function(e){e.isEnd||e[r]&&e[r].feId==o&&(e.update({dir:n,x:h,y:l}),e.lineCoordinate(a,t.rectWidth))}),t.flowchart.drawLines(a)}}}),$(\"body\").on(\"dragend\",\"#\"+this.feId+\">.title-wraper>.dragableRect\",function(e){if(e=e.originalEvent,t.isLinging=!1,e.preventDefault(),t.stopScroll(),t.flowchart.lines.find(function(t){return!t.isEnd})){var i=t.flowchart.lines.find(function(e){return!e.isEnd&&(!!(e.start&&t.feId==e.start.feId||e.end&&t.feId==e.end.feId)&&(e.destroy(),!0))});t.flowchart.lines=t.flowchart.lines.filter(function(t){return t!==i}),t.startModuleId=null,t.flowchart.drawLines(),t.flowchart.showNodes()}}),$(\"body\").unbind(\"drop.BaseModuleNode\"),$(\"body\").bind(\"drop.BaseModuleNode\",\".dragableRect\",function(e){(e=e.originalEvent).preventDefault(),t.stopScroll();var i=e.dataTransfer.getData(\"dragStartModuleId\");if(i&&(!$(e.target).hasClass(\"start\")||!$(e.target).hasClass(\"connected\"))){var s=i.split(\" \"),r=(s[1],\"start\"===s[0]?\"end\":\"start\"),n=$(e.target).parent().parent().attr(\"id\"),o=t.flowchart.scrollDistance(),a=t.flowchart&&t.flowchart.modules.find(function(t){return t.feId==n})||{};a.x,a.y,a.height;t.flowchart&&t.flowchart.lines.forEach(function(e){if(!e.isEnd&&!e[r]){var i={};i[r]={feId:n},e.setPoint(i),e.lineCoordinate(o,t.rectWidth);var s=t.flowchart.modules.find(function(t){return t.feId==e.start.feId})||{},a=t.flowchart.modules.find(function(t){return t.feId==e.end.feId})||{};s.feNextId=a.feId,e.isEnd=!0}}),t.flowchart.drawLines(),t.flowchart.showNodes()}})},a.prototype.moveScroll=function(t){if(!this.isAutoScroll){var e={x:t.pageX,y:t.pageY},i=this.flowchart.scrollParent.offsetValue||this.flowchart.scrollParent.offset(),s=this.flowchart.scrollParent.widthValue||this.flowchart.scrollParent.width(),r=this.flowchart.scrollParent.heightValue||this.flowchart.scrollParent.height(),n={dir:\"left\",start:{x:i.left,y:i.top},end:{x:i.left,y:i.top+r}},a={dir:\"right\",start:{x:i.left+s,y:i.top},end:{x:i.left+s,y:i.top+r}},h={dir:\"top\",start:{x:i.left,y:i.top},end:{x:i.left+s,y:i.top}},l={dir:\"bottom\",start:{x:i.left,y:i.top+r},end:{x:i.left+s,y:i.top+r}},c=o(e,n.start,n.end),d=o(e,a.start,a.end),f=o(e,h.start,h.end),u=o(e,l.start,l.end),p=Math.min(c,d,f,u);f===p?this.autoScroll(\"top\"):u===p?this.autoScroll(\"bottom\"):c===p?this.autoScroll(\"left\"):d===p&&this.autoScroll(\"right\")}},a.prototype.autoScroll=function(t){var e=this,i=0,s=0,r=0,n=0;clearInterval(this.timer),this.isAutoScroll=!0,\"top\"===t?this.timer=setInterval(function(){s=e.flowchart.scrollParent.scrollTop(),e.flowchart.scrollParent.scrollTop(Math.max(s-10,0)),(s<=0||!e.isDrag)&&e.stopScroll()},60):\"bottom\"===t?this.timer=setInterval(function(){s=e.flowchart.scrollParent.scrollTop(),r=e.flowchart.scrollParent.heightValue||e.flowchart.scrollParent.height(),(s+r>=e.flowchart.height||!e.isDrag)&&e.stopScroll(),e.flowchart.scrollParent.scrollTop(s+Math.min(10,e.flowchart.height-r))},60):\"left\"===t?this.timer=setInterval(function(){i=e.flowchart.scrollParent.scrollLeft(),e.flowchart.scrollParent.scrollLeft(Math.max(i-10,0)),(i<=0||!e.isDrag)&&e.stopScroll()},60):\"right\"===t&&(this.timer=setInterval(function(){i=e.flowchart.scrollParent.scrollLeft(),n=e.flowchart.scrollParent.widthValue||e.flowchart.scrollParent.width(),(i+n>=e.flowchart.width||!e.isDrag)&&e.stopScroll(),e.flowchart.scrollParent.scrollLeft(i+Math.min(10,e.flowchart.width-n))},60))},a.prototype.stopScroll=function(){clearInterval(this.timer),this.isAutoScroll=!1},a.prototype.moveStart=function(t,e){if(this.flowchart.cancelFocusLine(!0),!$(t.target).is(this.$setting)&&!$(t.target).hasClass(\"dragableRect\")){this.isDrag=!0,this.flowchart.onLineClickBind(t),this.stopScroll(),this.startmouseX=t.pageX,this.startmouseY=t.pageY,this.width=this.width||this.div.width(),this.height=this.height||this.div.height(),this.titleHeight=this.titleHeight||this.div.find(\"> .title-wraper\").height();var i=this.flowchart.scrollDistance();this.followPoint=\"center\"===e?{relativeX:this.width/2,relativeY:this.titleHeight/2}:{relativeX:t.pageX-this.flowchart.originX+i.scrollLeft-this.x,relativeY:t.pageY-this.flowchart.originY+i.scrollTop-this.y},this.div.addClass(\"isMoving\")}},a.prototype.moveEnd=function(t){if(this.isDrag)if(this.isDrag=!1,this.flowchart.clickLineOnModule)this.flowchart.clickLineOnModule=!1;else{this.div.removeClass(\"isMoving\");var e=this.flowchart.scrollDistance();this.height=$(\"#\"+this.feId).height();var i=t.pageX-this.originX+e.scrollLeft,s=t.pageY-this.originY+e.scrollTop;if(this.x<i&&i<this.x+this.width&&this.y<s&&s<this.y+this.height&&this.div.find(\".module-delete\").show(),t.pageX==this.startmouseX&&t.pageY==this.startmouseY&&this.hasSetting){var r=$.Event(\"modulesetting\",{module:Object.assign(this)});this.flowchart.canvas.triggerHandler(r)}this.stopScroll()}},a.prototype.moveDrag=function(t){if(!$(t.target).is(this.$setting)&&!$(t.target).hasClass(\"dragableRect\")&&this.isDrag)if(this.div.find(\".module-delete\").hide(),this.flowchart.inScrollParent({x:t.pageX,y:t.pageY},20)){this.stopScroll();var e=this.flowchart.scrollDistance();this.x=t.pageX+e.scrollLeft-this.flowchart.originX-this.followPoint.relativeX,this.y=t.pageY+e.scrollTop-this.flowchart.originY-this.followPoint.relativeY;var i=this.containerWidth||this.width,s=this.containerHeight||this.height,r=this;this.x<0&&(this.x=0),this.x>0+this.flowchart.width-i&&(this.x=this.flowchart.width-i),this.y<0&&(this.y=0),this.y>0+this.flowchart.height-s&&(this.y=this.flowchart.height-s),this.dragDom(),this.flowchart.lines.forEach(function(t){(t.start.feId===r.feId||t.end.feId===r.feId||r.children&&r.children.find(function(e){return e.feId===t.start.feId}))&&t.lineCoordinate(e,r.rectWidth)}),this.flowchart.drawLines()}else this.moveScroll(t)},a.prototype.contains=function(t,e){var i=document.getElementById(t);return i&&$.contains(i,e)},a.prototype.dragDom=function(){this.div.css({left:this.x,top:this.y})},a.prototype.destroy=function(){var t=this;this.flowchart.deleteRelaLines(this.feId,this.children),this.div.remove(),this.stopScroll(),this.flowchart.modules=this.flowchart.modules.filter(function(e){return e.feId!==t.feId})},h.prototype=new a,h.prototype.initDraw=function(){if(!this.feId){var t=this.flowchart.moduleRandomIds.shift(0);t||console.log(\"模块数量超出最大值1000\"),this.feId=\"containModule\"+(new Date).getTime()+t}this.init(),this.containDraw(),this.addBranch({feId:\"defaultChild\"+(new Date).getTime(),text:\"请添加分支\",canbeStart:!1,isDefaultBranch:!0}).initDraw()},h.prototype.addBranch=function(t){var e=this.children.length&&this.children.find(function(t){return~t.feId.indexOf(\"defaultChild\")});e&&(e.destroy(),this.children=this.children.filter(function(t){return!Boolean(~t.feId.indexOf(\"defaultChild\"))}));var i=new l(t=Object.assign(t,{$parent:this.$content,flowchart:this.flowchart,feParentId:this.feId,parentwidth:this.width,parentHeight:this.height,gap:this.childrenGap,childrenLength:this.children.length,containerId:this.feId}));return this.children.push(i),i},h.prototype.containDraw=function(){this.$content||(this.$content=$('<div class=\"children-wraper\"></div>'),this.div.append(this.$content))},h.prototype.removeChild=function(t){this.children=this.children.filter(function(e){if(e.feId!=t)return e;e.destroy()})},h.prototype.destroy=function(){this.flowchart.deleteRelaLines(this.feId,this.children),this.div.remove();this.flowchart.modules;var t=this;this.flowchart.modules=this.flowchart.modules.filter(function(e){return e.feId!==t.feId}),this.removeChildren()},h.prototype.removeChildren=function(){this.children.forEach(function(t){return t.destroy()}),this.children=[]},l.prototype=new a,l.prototype.initDraw=function(){if(!this.feId){var t=this.flowchart.moduleRandomIds.shift(0);t||console.log(\"模块数量超出最大值1000\"),this.feId=\"childModule\"+(new Date).getTime()+t}this.init()},c.prototype=new h,c.prototype.initDraw=function(){var t,e=this.children.concat([]);this.feId||((t=this.flowchart.moduleRandomIds.shift(0))||console.log(\"模块数量超出最大值1000\"),this.feId=\"specialBranch\"+(new Date).getTime()+t),this.init(),this.containDraw();e=this.children.concat([]);var i=this;this.children=[],e.forEach(function(t){i.addBranch(Object.assign(t)).initDraw()})},d.prototype.init=function(){var t,e,i,s,r=$('<div class=\"flowchart-father\" style=\"position: relative;overflow: auto; width: 100%; height: 100%\"></div');this.scrollParent=r,this.$parent=$('<div class=\"bgcontainer\"></div>'),this.canvas=$('<canvas class=\"flowchart-canvas\" ></canvas'),this.canvas.width=this.width,this.canvas.height=this.height,this.$wraper.append(this.scrollParent),this.showNodesWraper&&(this.$nodesWraper=$('<div class=\"nodes\"><span class=\"all-nodes\">总节点数：<span class=\"J-allNodes\"></span></span><span class=\"connected-nodes\">已连接节点数：<span class=\"J-connectedNodes\"></span></span></div>'),this.scrollParent.append(this.$nodesWraper),this.allNodesEle=this.scrollParent.find(\".J-allNodes\"),this.connectNodesEle=this.scrollParent.find(\".J-connectedNodes\")),this.$parent.append(this.canvas),this.scrollParent.append(this.$parent),this.ctx=this.canvas[0].getContext(\"2d\"),this.originX=this.scrollParent.offset().left,this.originY=this.scrollParent.offset().top,t=this.canvas,e=this.width,i=this.height,s=this.ratio,t.css({width:e,height:i}),t.attr({width:e*s,height:i*s});var n=this,o=$('<i class=\"'+this.deleteIcon+' delete-line\"></i>');o.widthValue=23,o.on(\"click\",function(t){n.deleteFocusLine()}),o.css({display:\"none\"}),this.$copyMove=$('<div id=\"copyMove\">1</div>'),this.scrollParent.append(o),this.scrollParent.append(this.$copyMove),this.$deLineIcon=o},d.prototype.initEvent=function(){var t=this;this.onLineBind=this.onLine.bind(this),this.onLineClickBind=this.onLineClick.bind(this),this.deleteLineBind=this.deleteLineEv.bind(this),this.scrollParent.on(\"mousemove\",this.onLineBind),this.scrollParent.on(\"click\",this.onLineClickBind),$(\"body\").on(\"keyup\",this.deleteLineBind),$(window).on(\"resize\",function(){t.originX=t.scrollParent.offset().left,t.originY=t.scrollParent.offset().top,t.lines.forEach(function(e){e.originX=t.originX,e.originY=t.originY}),this.flowchart.scrollParent.widthValue=this.flowchart.scrollParent.width(),this.flowchart.scrollParent.heightValue=this.flowchart.scrollParent.height()}),this.scrollParent.on(\"dragenter\",function(e){if(e.preventDefault(),t.creatingModule&&t.creatingModule.feType&&!t.creatingModule.moveStart){var i=t.scrollDistance(),s=e.pageX-t.originX+i.scrollLeft,r=e.pageY-t.originY+i.scrollTop;t.creatingModule=t.createRealModule(Object.assign(t.creatingModule,{x:s,y:r,toCenter:!0}),!1),t.creatingModule.moveStart(e,\"center\"),e.originalEvent.dataTransfer.dropEffect=\"move\"}}),this.scrollParent.on(\"dragover\",function(e){e.preventDefault(),t.creatingModule&&t.creatingModule.moveDrag&&(t.creatingModule.moveDrag(e),e.originalEvent.dataTransfer.dropEffect=\"move\")}),this.scrollParent.on(\"drop\",function(e){if(e.preventDefault(),t.creatingModule&&t.creatingModule.moveEnd){t.creatingModule.moveEnd(e);var i=Object.assign({},t.creatingModule);delete i.feId,delete i.$title,delete i.$icon,delete i.$content,delete i.toCenter,t.creatingModule.children&&t.creatingModule.children.map(function(t){return t.isDefaultBranch?Object.assign({},t):(delete t.feId,delete t.$title,delete t.$icon,Object.assign({},t))});var s=t.createRealModule(i);t.creatingModule.destroy(),t.creatingModule=null,s.children&&s.children.length&&s.children.forEach(function(e){t.modules.push(e)}),t.showNodes()}}),$(\"body\").on(\"dragend\",function(e){t.creatingModule&&(t.creatingModule.moveEnd&&t.creatingModule.moveEnd(e),t.creatingModule.destroy&&t.creatingModule.destroy(),t.creatingModule=null)})},d.prototype.deleteLine=function(t){if(t){((this.modules||[]).find(function(e){return e.feId==t.start.feId})||{}).feNextId=null,this.lines=this.lines.filter(function(e={}){return e.feId&&t.feId!=e.feId});var e=t.end&&t.end.feId;this.lines.find(function(t={}){return t.end&&e==t.end.feId});$(\"#\"+t.start.feId+\">.title-wraper>.dragableRect.start\").removeClass(\"connected\"),this.drawLines()}},d.prototype.deleteRelaLines=function(t,e=[]){var i=[t],s=[],r=this;e.forEach(function(t){return i.push(t.feId)}),i.forEach(function(t){s=s.concat(r.lines.filter(function(e){return e.start.feId==t||e.end.feId==t}))}),s.forEach(function(t){return r.deleteLine(t)})},d.prototype.onLine=function(t){t=t.originalEvent;var e=this.scrollDistance(),i=this,s=t.pageX-this.originX+e.scrollLeft,r=t.pageY-this.originY+e.scrollTop;this.scrollParent.css(\"cursor\",\"default\"),$(\".basemodule:hover\").css(\"cursor\",\"move\"),this.lines.forEach(function(e){e.isOnline(s,r)&&($(t.target).parents().hasClass(\"basemodule\")&&$(\".basemodule:hover\").css(\"cursor\",\"pointer\"),i.scrollParent.css(\"cursor\",\"pointer\"))})},d.prototype.onLineClick=function(t){t=t.originalEvent;var e=this.scrollDistance(),i=t.pageX-this.originX+e.scrollLeft,s=t.pageY-this.originY+e.scrollTop;this.cancelFocusLine(),this.clickLineOnModule=!1;var r=this.lines.find(function(t){return t.isOnline(i,s)});r?($(t.target).parents().hasClass(\"basemodule\")&&(this.clickLineOnModule=!0),r.focus=!0,r.lineWidth=3,this.showDelteLineIcon(t,e,r)):this.$deLineIcon.hide(),this.drawLines()},d.prototype.cancelFocusLine=function(t){this.lines.forEach(function(t){t.focus=!1,t.lineWidth=1}),t&&(this.drawLines(),this.$deLineIcon.hide())},d.prototype.showDelteLineIcon=function(t,e,i){var s,r,n=this.$deLineIcon.widthValue+3,o=(this.width,this.height,{x:-100,y:-100}),a={x:t.pageX-this.originX+e.scrollLeft,y:t.pageY-this.originY+e.scrollTop};if(i.sx===i.ex)a.x=i.ex,o.x=a.x-8-n,o.y=a.y,this.inCanvas(o,n,n)||(o.x=a.x-8);else if(i.sy===i.ey)a.y=i.ey,o.x=a.x,o.y=a.y-8-n,this.inCanvas(o,n,n)||(o.y=a.y+8);else{s=-(i.ex-i.sx)/(i.ey-i.sy),r=a.y-s*a.x;var h=this.getLinePoints(s,r,a,8);o=h.point1,h.point1.x<a.x&&(o.x=o.x-n),h.point1.y<a.y&&(o.y=o.y-n),this.inCanvas(o,n,n)||(o=h.point2),h.x<a.x&&(o.x=o.x-n),h.y<a.y&&(o.y=o.y-n)}this.$deLineIcon.css({display:\"block\",left:o.x+\"px\",top:o.y+\"px\"})},d.prototype.getLinePoints=function(t,e,i,s){var r=t*t+1,n=2*((e-i.y)*t-i.x),o=Math.pow(e-i.y,2)+Math.pow(i.x,2)-Math.pow(s,2),a=(-n-Math.sqrt(Math.pow(n,2)-4*r*o))/(2*r),h=a*t+e,l=(-n+Math.sqrt(Math.pow(n,2)-4*r*o))/(2*r);return{point1:{x:a,y:h},point2:{x:l,y:l*t+e}}},d.prototype.inCanvas=function(t,e,i){return 0<t.x&&t.x+e<this.width&&0<t.y&&t.y+i<this.height},d.prototype.inScrollParent=function(t,e){var i=this.scrollParent.offsetValue||this.scrollParent.offset(),s=this.scrollParent.widthValue||this.scrollParent.width(),r=this.scrollParent.heightValue||this.scrollParent.height();return this.scrollParent.offsetValue=i,this.scrollParent.widthValue=s,this.scrollParent.heightValue=r,e=e||0,i.left+e<t.x&&t.x<i.left+s-e&&i.top+e<t.y&&t.y<i.top+r-e},d.prototype.deleteLineEv=function(t){\"Backspace\"==t.key&&this.deleteFocusLine()},d.prototype.deleteFocusLine=function(t){var e=this.lines.find(function(t){return t.focus});this.deleteLine(e),this.$deLineIcon.hide(),this.showNodes()},d.prototype.drawLines=function(t){var e=this.ratio,i=this;this.ctx.clearRect(0,0,this.width*e,this.height*e),t=t||this.scrollDistance(),this.ctx.strokeStyle=this.themeColor,this.lines&&this.lines.forEach(function(t){i.ctx.beginPath(),t.focus?i.ctx.lineWidth=t.lineWidth*e:i.ctx.lineWidth=1*e,i.ctx.moveTo(t.sx*e,t.sy*e),i.ctx.lineTo(t.ex*e,t.ey*e),i.ctx.closePath(),i.ctx.stroke()})},d.prototype.createModule=function(t){if(t.isDragCreate=t.isDragCreate||!1,!t.isDragCreate){var e=this.createRealModule(t,!0);return this.showNodes(),e}this.creatingModule=Object.assign(t,{originX:this.originX,originY:this.originY,flowchart:this,feType:t.feType}),this.creatingModule},d.prototype.createRealModule=function(t,e=!0){var i=null,s=t.feType||\"normal\";if(\"normal\"==s)Object.assign(t,{originX:this.originX,originY:this.originY,flowchart:this,feType:s}),(i=new a(t)).init();else if(\"branchmodule\"==s)Object.assign(t,{originX:this.originX,originY:this.originY,flowchart:this,feType:s}),(i=new h(t)).initDraw();else if(\"branch\"==s&&t.feParentId){var r=this.modules&&this.modules.find(function(e){return e.feId&&e.feId==t.feParentId});r&&\"function\"==typeof r.addBranch&&(i=r.addBranch(t)).initDraw()}else\"specialBranch\"==s&&(Object.assign(t,{originX:this.originX,originY:this.originY,flowchart:this,feType:s}),(i=new c(t)).initDraw());return i&&(i.drawLines=this.drawLines.bind(this),i.deleteRelaLines=this.deleteRelaLines.bind(this)),e&&i&&this.modules.push(i),i},d.prototype.updateModule=function(t){this.modules.find(function(e){return e.feId===t.feId}).update(t)},d.prototype.removeChildModule=function(t,e){this.modules.find(function(e){return e.feId===t}).removeChild(e),this.showNodes()},d.prototype.removeChildren=function(t){this.modules.find(function(e){return e.feId===t}).removeChildren(),this.showNodes()},d.prototype.createChildren=function(t,e=[]){var i=this.modules.find(function(e){return e.feId===t}),s=this,r=this.scrollDistance();e.forEach(function(t){var e=i.addBranch(t);e.initDraw(),s.moduleLineRestore(e,r),s.modules.push(e)}),s.showNodes(),this.drawLines()},d.prototype.scrollDistance=function(){return{scrollLeft:this.scrollParent.scrollLeft()||0,scrollTop:this.scrollParent.scrollTop()||0}},d.prototype.destroy=function(){this.scrollParent.off(\"mousemove\",this.onLineBind),this.scrollParent.off(\"click\",this.onLineClickBind),$(\"body\").off(\"keyup\",this.deleteLineBind)},d.prototype.getAllNodes=function(){return(this.scrollParent.find(\".dragableRect\")||[]).length},d.prototype.getConnectedNodes=function(){return(this.scrollParent.find(\".dragableRect.connected\")||[]).length},d.prototype.showNodes=function(){var t=this.getAllNodes(),e=this.getConnectedNodes();this.allNodesEle.html(t),this.connectNodesEle.html(e)},d.prototype.save=function(){var t=[];return this.modules.forEach(function(e){var i={feId:e.feId,feNextId:e.feNextId,feParentId:e.feParentId,text:e.text,type:e.type,data:e.data,viewInfo:JSON.stringify({feType:e.feType,feId:e.feId,feNextId:e.feNextId,feParentId:e.feParentId,titleIcon:e.titleIcon,x:e.x,y:e.y,isFirst:e.isFirst,isLast:e.isLast,canbeStart:e.canbeStart,canbeEnd:e.canbeEnd,hasDelete:e.hasDelete,hasSetting:e.hasSetting,settingCallback:e.settingCallback,isDefaultBranch:e.isDefaultBranch})};t.push(i)}),localStorage.setItem(\"modules\",JSON.stringify(t)),t},d.prototype.restore=function(t=[]){if(!t.length){if(!localStorage.getItem(\"modules\"))return;t=JSON.parse(localStorage.getItem(\"modules\"))}t.map(function(t){return Object.assign(t,JSON.parse(t.viewInfo))});var e=this.scrollDistance(),i=this,s=t.filter(function(t){return\"branch\"===t.feType});t.filter(function(t){return\"branch\"!==t.feType}).forEach(function(t){i.moduleRestore(t)}),s.forEach(function(t){i.moduleRestore(t)}),this.lines.forEach(function(t){t.styleEndPonit(),t.lineCoordinate(e,i.rectWidth)}),this.drawLines(),this.showNodes()},d.prototype.moduleRestore=function(t){var e=this.createRealModule(Object.assign(t));this.moduleLineRestore(e)},d.prototype.moduleLineRestore=function(t,e){if(t.feNextId){var i=this.lineRandomIds.shift(0);i||console.log(\"线段超出最大值1000\");var s=\"line\"+(new Date).getTime()+i,n=new r({originX:this.originX,originY:this.originY,feId:s});n.setPoint({start:{feId:t.feId},end:{feId:t.feNextId}}),e&&n.lineCoordinate(e,this.rectWidth),this.lines.push(n)}};var f=d;window.Flowchart=f;e.default=f}]);","extractedComments":[]}